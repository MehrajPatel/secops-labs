name: OWASP ZAP DAST Scan

on:
  push:
    branches: ["main"]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan the web application
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install flask
          # Add any other dependencies if needed

      # 1. Start the app and log output to a file for debugging
      - name: Start Web App
        run: |
          python app.py > log.txt 2>&1 &
          
      # 2. Wait and Verify the app is actually responding
      - name: Verify App is Up
        run: |
          timeout 30s bash -c 'until curl -s http://127.0.0.1:5000/; do sleep 2; done'
          echo "App is confirmed UP"

      # 3. FIX PERMISSIONS: Ensure the workspace is writable
      - name: Prepare Workspace for ZAP
        run: chmod -R 777  ${{ github.workspace }}

      # 4. Run ZAP Baseline Scan
      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          # Use 127.0.0.1 instead of localhost to avoid IPv6 issues
          target: 'http://127.0.0.1:5000/'
          fail_action: false
          artifact_name: 'zap-scan-report'
          # Remove docker_run_options (invalid input)
          # Use cmd_options if you need to pass specific ZAP script flags
          cmd_options: '-j' 

      # 5. Debugging: If it fails, show the app logs
      - name: Show App Logs on Failure
        if: failure()
        run: cat log.txt